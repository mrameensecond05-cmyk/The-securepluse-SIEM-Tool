version: '3.8'

services:
  # --- Infrastructure ---
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api-gateway
      - wazuh-dashboard
    networks:
      - securepulse-net

  mysql:
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: securepulse
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./database/seed_data.sql:/docker-entrypoint-initdb.d/seed_data.sql
    networks:
      - securepulse-net

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    restart: always
    environment:
      PMA_HOST: mysql
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    ports:
      - "8081:80"
    depends_on:
      - mysql
    networks:
      - securepulse-net

  redis:
    image: redis:7.2-alpine
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - securepulse-net

  # --- Core Backend ---
  api-gateway:
    build: ./api-gateway
    restart: always
    ports:
      - "5000:5000"
    environment:
      - PORT=5000
      - JWT_SECRET=${JWT_SECRET}
      - REDIS_URL=redis://redis:6379
      - DB_HOST=mysql
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=securepulse
    depends_on:
      - mysql
      - redis
    networks:
      - securepulse-net

  # --- Microservices ---
  auth-service:
    build: ./services/auth
    restart: always
    ports:
      - "8001:8001"
    environment:
      - PORT=8001
      - DB_HOST=mysql
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
    depends_on:
      - mysql
    networks:
      - securepulse-net

  inventory-service:
    build: ./services/inventory
    restart: always
    ports:
      - "8002:8002"
    environment:
      - PORT=8002
      - DB_HOST=mysql
    depends_on:
      - mysql
    networks:
      - securepulse-net

  soc-service:
    build: ./services/soc
    restart: always
    ports:
      - "8003:8003"
    environment:
      - PORT=8003
      - WAZUH_API_URL=https://wazuh-manager:55000
      - WAZUH_API_USER=${WAZUH_API_USER}
      - WAZUH_API_PASSWORD=${WAZUH_API_PASSWORD}
    depends_on:
      - wazuh-manager
      - mysql
    networks:
      - securepulse-net

  ai-service:
    build: ./services/ai
    restart: always
    ports:
      - "8004:8004"
    environment:
      - PORT=8004
      - OLLAMA_HOST=http://ollama:11434
      - CHROMA_HOST=http://chromadb:8000
    depends_on:
      - ollama
      - chromadb
    networks:
      - securepulse-net

  reports-service:
    build: ./services/reports
    restart: always
    ports:
      - "8005:8005"
    environment:
      - PORT=8005
      - DB_HOST=mysql
    depends_on:
      - mysql
    networks:
      - securepulse-net

  # --- Security (Wazuh) ---
  wazuh-manager:
    image: wazuh/wazuh-manager:4.7.2
    hostname: wazuh-manager
    restart: always
    ports:
      - "1514:1514"
      - "1515:1515"
      - "55000:55000"
    volumes:
      - wazuh_api_configuration:/var/ossec/api/configuration
      - wazuh_etc:/var/ossec/etc
      - wazuh_logs:/var/ossec/logs
      - wazuh_queue:/var/ossec/queue
    networks:
      - securepulse-net

  wazuh-indexer:
    image: wazuh/wazuh-indexer:4.7.2
    hostname: wazuh-indexer
    restart: always
    ports:
      - "9200:9200"
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - wazuh_indexer_data:/var/lib/wazuh-indexer
    networks:
      - securepulse-net

  wazuh-dashboard:
    image: wazuh/wazuh-dashboard:4.7.2
    hostname: wazuh-dashboard
    restart: always
    ports:
      - "5601:5601"
    environment:
      - WAZUH_API_URL=https://wazuh-manager:55000
    depends_on:
      - wazuh-indexer
    networks:
      - securepulse-net

  # --- AI ---
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - securepulse-net

  chromadb:
    image: chromadb/chroma:latest
    ports:
      - "8000:8000"
    volumes:
      - chroma_data:/chroma/chroma
    networks:
      - securepulse-net

networks:
  securepulse-net:
    driver: bridge

volumes:
  mysql_data:
  redis_data:
  wazuh_api_configuration:
  wazuh_etc:
  wazuh_logs:
  wazuh_queue:
  wazuh_indexer_data:
  ollama_data:
  chroma_data:
